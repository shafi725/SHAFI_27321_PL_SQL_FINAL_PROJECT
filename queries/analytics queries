-- ============================================
-- ANALYTICS QUERIES FOR MICROFINANCE MMS
-- ============================================

-- 1. PORTFOLIO PERFORMANCE ANALYSIS

SELECT 
    EXTRACT(YEAR FROM DISBURSEMENT_DATE) AS YEAR,
    EXTRACT(MONTH FROM DISBURSEMENT_DATE) AS MONTH,
    COUNT(*) AS LOANS_DISBURSED,
    SUM(LOAN_AMOUNT) AS TOTAL_DISBURSED,
    AVG(LOAN_AMOUNT) AS AVG_LOAN_SIZE,
    SUM(CASE WHEN STATUS = 'Paid Off' THEN LOAN_AMOUNT ELSE 0 END) AS AMOUNT_RECOVERED,
    SUM(CASE WHEN STATUS = 'Overdue' THEN LOAN_AMOUNT ELSE 0 END) AS AMOUNT_OVERDUE,
    ROUND((SUM(CASE WHEN STATUS = 'Paid Off' THEN LOAN_AMOUNT ELSE 0 END) / 
           SUM(LOAN_AMOUNT)) * 100, 2) AS RECOVERY_RATE_PERCENT
FROM LOANS
GROUP BY EXTRACT(YEAR FROM DISBURSEMENT_DATE), EXTRACT(MONTH FROM DISBURSEMENT_DATE)
ORDER BY YEAR DESC, MONTH DESC;

-- 2. INTEREST INCOME ANALYSIS

SELECT 
    EXTRACT(YEAR FROM r.REPAYMENT_DATE) AS YEAR,
    EXTRACT(MONTH FROM r.REPAYMENT_DATE) AS MONTH,
    COUNT(DISTINCT r.LOAN_ID) AS LOANS_WITH_PAYMENTS,
    SUM(r.AMOUNT_PAID) AS TOTAL_COLLECTED,
    SUM(r.INTEREST_AMOUNT) AS TOTAL_INTEREST_COLLECTED,
    SUM(r.PRINCIPAL_AMOUNT) AS TOTAL_PRINCIPAL_COLLECTED,
    ROUND((SUM(r.INTEREST_AMOUNT) / SUM(r.AMOUNT_PAID)) * 100, 2) AS INTEREST_PERCENTAGE
FROM REPAYMENTS r
WHERE r.STATUS = 'Paid'
GROUP BY EXTRACT(YEAR FROM r.REPAYMENT_DATE), EXTRACT(MONTH FROM r.REPAYMENT_DATE)
ORDER BY YEAR DESC, MONTH DESC;

-- 3. DEFAULT RISK ANALYSIS

WITH LoanStats AS (
    SELECT 
        l.LOAN_ID,
        l.LOAN_AMOUNT,
        l.INTEREST_RATE,
        l.TERM_MONTHS,
        l.STATUS,
        NVL(SUM(r.AMOUNT_PAID), 0) AS TOTAL_PAID,
        CASE 
            WHEN l.STATUS = 'Overdue' THEN 1
            WHEN l.STATUS = 'Active' AND ADD_MONTHS(l.DISBURSEMENT_DATE, l.TERM_MONTHS) < SYSDATE THEN 1
            ELSE 0
        END AS IS_DEFAULT
    FROM LOANS l
    LEFT JOIN REPAYMENTS r ON l.LOAN_ID = r.LOAN_ID
    GROUP BY l.LOAN_ID, l.LOAN_AMOUNT, l.INTEREST_RATE, l.TERM_MONTHS, 
             l.STATUS, l.DISBURSEMENT_DATE
)
SELECT 
    CASE 
        WHEN LOAN_AMOUNT <= 1000000 THEN 'Small (≤1M)'
        WHEN LOAN_AMOUNT <= 5000000 THEN 'Medium (1M-5M)'
        ELSE 'Large (>5M)'
    END AS LOAN_SIZE_CATEGORY,
    COUNT(*) AS TOTAL_LOANS,
    SUM(IS_DEFAULT) AS DEFAULTED_LOANS,
    ROUND((SUM(IS_DEFAULT) / COUNT(*)) * 100, 2) AS DEFAULT_RATE,
    AVG(INTEREST_RATE) AS AVG_INTEREST_RATE,
    AVG(TERM_MONTHS) AS AVG_TERM_MONTHS
FROM LoanStats
GROUP BY CASE 
    WHEN LOAN_AMOUNT <= 1000000 THEN 'Small (≤1M)'
    WHEN LOAN_AMOUNT <= 5000000 THEN 'Medium (1M-5M)'
    ELSE 'Large (>5M)'
END
ORDER BY DEFAULT_RATE DESC;

-- 4. CUSTOMER LIFETIME VALUE ANALYSIS

WITH CustomerLoanHistory AS (
    SELECT 
        a.APPLICANT_ID,
        a.FIRST_NAME || ' ' || a.LAST_NAME AS CUSTOMER_NAME,
        a.JOINING_DATE,
        COUNT(l.LOAN_ID) AS TOTAL_LOANS,
        SUM(l.LOAN_AMOUNT) AS TOTAL_BORROWED,
        SUM(CASE WHEN l.STATUS = 'Paid Off' THEN l.LOAN_AMOUNT ELSE 0 END) AS TOTAL_REPAID,
        MAX(l.DISBURSEMENT_DATE) AS LATEST_LOAN_DATE,
        SUM(r.INTEREST_AMOUNT) AS TOTAL_INTEREST_PAID
    FROM APPLICANTS a
    LEFT JOIN LOANS l ON a.APPLICANT_ID = l.APPLICANT_ID
    LEFT JOIN REPAYMENTS r ON l.LOAN_ID = r.LOAN_ID
    GROUP BY a.APPLICANT_ID, a.FIRST_NAME, a.LAST_NAME, a.JOINING_DATE
)
SELECT 
    APPLICANT_ID,
    CUSTOMER_NAME,
    JOINING_DATE,
    TOTAL_LOANS,
    TOTAL_BORROWED,
    TOTAL_REPAID,
    TOTAL_INTEREST_PAID,
    ROUND(TOTAL_INTEREST_PAID / NULLIF(TOTAL_BORROWED, 0) * 100, 2) AS INTEREST_TO_PRINCIPAL_RATIO,
    CASE 
        WHEN TOTAL_LOANS >= 3 AND TOTAL_REPAID >= TOTAL_BORROWED THEN 'Platinum'
        WHEN TOTAL_LOANS >= 2 THEN 'Gold'
        WHEN TOTAL_LOANS = 1 THEN 'Silver'
        ELSE 'New'
    END AS CUSTOMER_SEGMENT
FROM CustomerLoanHistory
ORDER BY TOTAL_INTEREST_PAID DESC;

-- 5. MONTHLY COLLECTION EFFICIENCY

WITH MonthlyCollections AS (
    SELECT 
        EXTRACT(YEAR FROM r.REPAYMENT_DATE) AS YEAR,
        EXTRACT(MONTH FROM r.REPAYMENT_DATE) AS MONTH,
        SUM(r.AMOUNT_PAID) AS ACTUAL_COLLECTIONS,
        (SELECT SUM(l.LOAN_AMOUNT/l.TERM_MONTHS) 
         FROM LOANS l 
         WHERE l.STATUS = 'Active'
         AND ADD_MONTHS(l.DISBURSEMENT_DATE, l.TERM_MONTHS) >= 
             TO_DATE(EXTRACT(YEAR FROM r.REPAYMENT_DATE) || '-' || 
                     EXTRACT(MONTH FROM r.REPAYMENT_DATE) || '-01', 'YYYY-MM-DD')
         AND l.DISBURSEMENT_DATE <= 
             TO_DATE(EXTRACT(YEAR FROM r.REPAYMENT_DATE) || '-' || 
                     EXTRACT(MONTH FROM r.REPAYMENT_DATE) || '-01', 'YYYY-MM-DD')) AS EXPECTED_COLLECTIONS
    FROM REPAYMENTS r
    WHERE r.STATUS = 'Paid'
    GROUP BY EXTRACT(YEAR FROM r.REPAYMENT_DATE), EXTRACT(MONTH FROM r.REPAYMENT_DATE)
)
SELECT 
    YEAR,
    MONTH,
    ACTUAL_COLLECTIONS,
    EXPECTED_COLLECTIONS,
    ROUND((ACTUAL_COLLECTIONS / NULLIF(EXPECTED_COLLECTIONS, 0)) * 100, 2) AS COLLECTION_EFFICIENCY_PERCENT
FROM MonthlyCollections
ORDER BY YEAR DESC, MONTH DESC;

-- 6. LOAN DISTRIBUTION ANALYSIS

SELECT 
    ROUND(LOAN_AMOUNT/1000000) * 1000000 AS LOAN_BUCKET,
    COUNT(*) AS NUMBER_OF_LOANS,
    SUM(LOAN_AMOUNT) AS TOTAL_AMOUNT,
    AVG(INTEREST_RATE) AS AVG_INTEREST_RATE,
    AVG(TERM_MONTHS) AS AVG_TERM_MONTHS,
    SUM(CASE WHEN STATUS = 'Paid Off' THEN 1 ELSE 0 END) AS PAID_OFF_COUNT,
    SUM(CASE WHEN STATUS = 'Overdue' THEN 1 ELSE 0 END) AS OVERDUE_COUNT,
    ROUND((SUM(CASE WHEN STATUS = 'Paid Off' THEN 1 ELSE 0 END) / COUNT(*)) * 100, 2) AS SUCCESS_RATE
FROM LOANS
GROUP BY ROUND(LOAN_AMOUNT/1000000) * 1000000
ORDER BY LOAN_BUCKET;

-- 7. SEASONALITY ANALYSIS

SELECT 
    TO_CHAR(DISBURSEMENT_DATE, 'Month') AS MONTH_NAME,
    EXTRACT(MONTH FROM DISBURSEMENT_DATE) AS MONTH_NUMBER,
    COUNT(*) AS LOANS_DISBURSED,
    SUM(LOAN_AMOUNT) AS TOTAL_DISBURSED,
    AVG(LOAN_AMOUNT) AS AVG_LOAN_SIZE,
    AVG(INTEREST_RATE) AS AVG_INTEREST_RATE
FROM LOANS
GROUP BY TO_CHAR(DISBURSEMENT_DATE, 'Month'), EXTRACT(MONTH FROM DISBURSEMENT_DATE)
ORDER BY MONTH_NUMBER;

-- 8. REPAYMENT BEHAVIOR ANALYSIS

SELECT 
    l.APPLICANT_ID,
    a.FIRST_NAME || ' ' || a.LAST_NAME AS APPLICANT_NAME,
    COUNT(r.REPAYMENT_ID) AS TOTAL_PAYMENTS,
    AVG(r.AMOUNT_PAID) AS AVG_PAYMENT_AMOUNT,
    STDDEV(r.AMOUNT_PAID) AS PAYMENT_VARIABILITY,
    MIN(r.REPAYMENT_DATE) AS FIRST_PAYMENT_DATE,
    MAX(r.REPAYMENT_DATE) AS LAST_PAYMENT_DATE,
    COUNT(DISTINCT TRUNC(r.REPAYMENT_DATE, 'MONTH')) AS PAYMENT_MONTHS,
    ROUND(COUNT(r.REPAYMENT_ID) / 
          NULLIF(COUNT(DISTINCT TRUNC(r.REPAYMENT_DATE, 'MONTH')), 0), 2) AS PAYMENTS_PER_MONTH
FROM LOANS l
JOIN APPLICANTS a ON l.APPLICANT_ID = a.APPLICANT_ID
JOIN REPAYMENTS r ON l.LOAN_ID = r.LOAN_ID
WHERE r.STATUS = 'Paid'
GROUP BY l.APPLICANT_ID, a.FIRST_NAME, a.LAST_NAME
HAVING COUNT(r.REPAYMENT_ID) >= 3
ORDER BY PAYMENTS_PER_MONTH DESC;

-- 9. INTEREST RATE VS DEFAULT CORRELATION

SELECT 
    ROUND(INTEREST_RATE) AS INTEREST_RATE_BUCKET,
    COUNT(*) AS TOTAL_LOANS,
    SUM(CASE WHEN STATUS = 'Overdue' THEN 1 ELSE 0 END) AS OVERDUE_COUNT,
    SUM(CASE WHEN STATUS = 'Paid Off' THEN 1 ELSE 0 END) AS PAID_OFF_COUNT,
    ROUND((SUM(CASE WHEN STATUS = 'Overdue' THEN 1 ELSE 0 END) / COUNT(*)) * 100, 2) AS OVERDUE_RATE,
    AVG(LOAN_AMOUNT) AS AVG_LOAN_SIZE,
    AVG(TERM_MONTHS) AS AVG_TERM_MONTHS
FROM LOANS
GROUP BY ROUND(INTEREST_RATE)
ORDER BY INTEREST_RATE_BUCKET;

-- 10. PORTFOLIO AT RISK (PAR) ANALYSIS

WITH CurrentStatus AS (
    SELECT 
        l.LOAN_ID,
        l.LOAN_AMOUNT,
        l.STATUS,
        NVL(SUM(r.AMOUNT_PAID), 0) AS TOTAL_PAID,
        l.LOAN_AMOUNT - NVL(SUM(r.AMOUNT_PAID), 0) AS OUTSTANDING_BALANCE,
        CASE 
            WHEN l.STATUS = 'Overdue' THEN l.LOAN_AMOUNT - NVL(SUM(r.AMOUNT_PAID), 0)
            WHEN l.STATUS = 'Active' AND ADD_MONTHS(l.DISBURSEMENT_DATE, l.TERM_MONTHS) < SYSDATE 
            THEN l.LOAN_AMOUNT - NVL(SUM(r.AMOUNT_PAID), 0)
            ELSE 0
        END AS RISK_AMOUNT
    FROM LOANS l
    LEFT JOIN REPAYMENTS r ON l.LOAN_ID = r.LOAN_ID
    GROUP BY l.LOAN_ID, l.LOAN_AMOUNT, l.STATUS, l.DISBURSEMENT_DATE, l.TERM_MONTHS
)
SELECT 
    'Portfolio at Risk (PAR)' AS METRIC,
    SUM(RISK_AMOUNT) AS RISK_AMOUNT,
    SUM(OUTSTANDING_BALANCE) AS TOTAL_OUTSTANDING,
    ROUND((SUM(RISK_AMOUNT) / NULLIF(SUM(OUTSTANDING_BALANCE), 0)) * 100, 2) AS PAR_PERCENT
FROM CurrentStatus
UNION ALL
SELECT 
    'PAR by Days Overdue' AS METRIC,
    SUM(CASE 
        WHEN l.STATUS = 'Overdue' AND SYSDATE - (SELECT MAX(REPAYMENT_DATE) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID) <= 30 
        THEN l.LOAN_AMOUNT - (SELECT NVL(SUM(AMOUNT_PAID), 0) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID)
        ELSE 0 
    END) AS RISK_AMOUNT,
    SUM(l.LOAN_AMOUNT - (SELECT NVL(SUM(AMOUNT_PAID), 0) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID)) AS TOTAL_OUTSTANDING,
    ROUND((SUM(CASE 
        WHEN l.STATUS = 'Overdue' AND SYSDATE - (SELECT MAX(REPAYMENT_DATE) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID) <= 30 
        THEN l.LOAN_AMOUNT - (SELECT NVL(SUM(AMOUNT_PAID), 0) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID)
        ELSE 0 
    END) / NULLIF(SUM(l.LOAN_AMOUNT - (SELECT NVL(SUM(AMOUNT_PAID), 0) FROM REPAYMENTS WHERE LOAN_ID = l.LOAN_ID)), 0)) * 100, 2) AS PAR_PERCENT
FROM LOANS l;