-- ============================================
-- AUDIT AND MONITORING QUERIES FOR MMS
-- ============================================

-- 1. LOAN STATUS CHANGE AUDIT TRAIL

SELECT 
    la.AUDIT_ID,
    la.LOAN_ID,
    l.APPLICANT_ID,
    a.FIRST_NAME || ' ' || a.LAST_NAME AS APPLICANT_NAME,
    la.ACTION,
    la.ACTION_DATE,
    la.OLD_STATUS,
    la.NEW_STATUS,
    la.USER_NAME,
    la.DESCRIPTION,
    DATEDIFF('MINUTE', la.ACTION_DATE, SYSDATE) AS MINUTES_AGO
FROM LOAN_AUDIT la
JOIN LOANS l ON la.LOAN_ID = l.LOAN_ID
JOIN APPLICANTS a ON l.APPLICANT_ID = a.APPLICANT_ID
ORDER BY la.ACTION_DATE DESC;

-- 2. USER ACTIVITY AUDIT (Assuming you have user login/log table)

-- Create user audit table if not exists
-- CREATE TABLE USER_AUDIT (
--     AUDIT_ID NUMBER(10) PRIMARY KEY,
--     USER_NAME VARCHAR2(50),
--     ACTION VARCHAR2(100),
--     ACTION_DATE DATE,
--     IP_ADDRESS VARCHAR2(50),
--     SESSION_ID VARCHAR2(100),
--     DETAILS CLOB
-- );

SELECT 
    USER_NAME,
    ACTION,
    COUNT(*) AS ACTION_COUNT,
    MIN(ACTION_DATE) AS FIRST_ACTION,
    MAX(ACTION_DATE) AS LAST_ACTION,
    LISTAGG(DISTINCT TO_CHAR(ACTION_DATE, 'YYYY-MM-DD'), ', ') WITHIN GROUP (ORDER BY ACTION_DATE) AS ACTIVE_DATES
FROM USER_AUDIT
WHERE ACTION_DATE >= SYSDATE - 30  -- Last 30 days
GROUP BY USER_NAME, ACTION
ORDER BY ACTION_COUNT DESC;

-- 3. DATA INTEGRITY CHECKS

-- Loans without applicants
SELECT 
    l.LOAN_ID,
    l.APPLICANT_ID,
    l.LOAN_AMOUNT,
    l.STATUS
FROM LOANS l
WHERE NOT EXISTS (
    SELECT 1 FROM APPLICANTS a 
    WHERE a.APPLICANT_ID = l.APPLICANT_ID
);

-- Repayments without valid loans
SELECT 
    r.REPAYMENT_ID,
    r.LOAN_ID,
    r.AMOUNT_PAID,
    r.REPAYMENT_DATE
FROM REPAYMENTS r
WHERE NOT EXISTS (
    SELECT 1 FROM LOANS l 
    WHERE l.LOAN_ID = r.LOAN_ID
);

-- 4. UNUSUAL ACTIVITY DETECTION

-- Multiple status changes in short period
SELECT 
    la.LOAN_ID,
    COUNT(*) AS STATUS_CHANGES,
    MIN(ACTION_DATE) AS FIRST_CHANGE,
    MAX(ACTION_DATE) AS LAST_CHANGE,
    DATEDIFF('MINUTE', MIN(ACTION_DATE), MAX(ACTION_DATE)) AS TIME_SPAN_MINUTES,
    LISTAGG(NEW_STATUS, ' -> ') WITHIN GROUP (ORDER BY ACTION_DATE) AS STATUS_FLOW
FROM LOAN_AUDIT la
WHERE ACTION = 'STATUS_CHANGE'
GROUP BY la.LOAN_ID
HAVING COUNT(*) >= 3 
   AND DATEDIFF('MINUTE', MIN(ACTION_DATE), MAX(ACTION_DATE)) <= 60  -- 3+ changes within 1 hour
ORDER BY STATUS_CHANGES DESC;

-- 5. FINANCIAL DISCREPANCY AUDIT

-- Loans where total repayments exceed loan amount
SELECT 
    l.LOAN_ID,
    l.APPLICANT_ID,
    l.LOAN_AMOUNT,
    l.STATUS,
    NVL(SUM(r.AMOUNT_PAID), 0) AS TOTAL_PAID,
    NVL(SUM(r.AMOUNT_PAID), 0) - l.LOAN_AMOUNT AS OVERPAYMENT
FROM LOANS l
LEFT JOIN REPAYMENTS r ON l.LOAN_ID = r.LOAN_ID
GROUP BY l.LOAN_ID, l.APPLICANT_ID, l.LOAN_AMOUNT, l.STATUS
HAVING NVL(SUM(r.AMOUNT_PAID), 0) > l.LOAN_AMOUNT
ORDER BY OVERPAYMENT DESC;

-- 6. SYSTEM CONFIGURATION AUDIT

-- Check trigger status (Oracle-specific)
SELECT 
    TRIGGER_NAME,
    TRIGGER_TYPE,
    TRIGGERING_EVENT,
    TABLE_NAME,
    STATUS,
    CREATED,
    LAST_DDL_TIME
FROM USER_TRIGGERS
WHERE TABLE_NAME IN ('LOANS', 'REPAYMENTS', 'APPLICANTS')
ORDER BY TABLE_NAME, TRIGGER_NAME;

-- 7. DATA MODIFICATION AUDIT

-- Recent data modifications
SELECT 
    'LOANS' AS TABLE_NAME,
    COUNT(*) AS MODIFICATION_COUNT,
    MIN(ACTION_DATE) AS FIRST_MODIFICATION,
    MAX(ACTION_DATE) AS LAST_MODIFICATION
FROM LOAN_AUDIT
WHERE ACTION_DATE >= SYSDATE - 1  -- Last 24 hours
UNION ALL
SELECT 
    'REPAYMENTS' AS TABLE_NAME,
    COUNT(*) AS MODIFICATION_COUNT,
    MIN(ACTION_DATE) AS FIRST_MODIFICATION,
    MAX(ACTION_DATE) AS LAST_MODIFICATION
FROM REPAYMENT_AUDIT  -- Assuming similar audit table for repayments
WHERE ACTION_DATE >= SYSDATE - 1;

-- 8. SECURITY AUDIT QUERIES

-- Failed login attempts
SELECT 
    USER_NAME,
    IP_ADDRESS,
    COUNT(*) AS FAILED_ATTEMPTS,
    MIN(ACTION_DATE) AS FIRST_ATTEMPT,
    MAX(ACTION_DATE) AS LATEST_ATTEMPT
FROM USER_AUDIT
WHERE ACTION = 'LOGIN_FAILED'
  AND ACTION_DATE >= SYSDATE - 7  -- Last 7 days
GROUP BY USER_NAME, IP_ADDRESS
HAVING COUNT(*) >= 3  -- Multiple failed attempts
ORDER BY FAILED_ATTEMPTS DESC;

-- 9. COMPLIANCE AUDIT

-- Loans exceeding regulatory limits (example thresholds)
SELECT 
    l.LOAN_ID,
    l.APPLICANT_ID,
    a.FIRST_NAME || ' ' || a.LAST_NAME AS APPLICANT_NAME,
    l.LOAN_AMOUNT,
    l.INTEREST_RATE,
    CASE 
        WHEN l.INTEREST_RATE > 15 THEN 'INTEREST_RATE_EXCEEDED'
        WHEN l.LOAN_AMOUNT > 10000000 THEN 'LOAN_AMOUNT_EXCEEDED'
        WHEN l.TERM_MONTHS > 60 THEN 'TERM_EXCEEDED'
        ELSE 'WITHIN_LIMITS'
    END AS COMPLIANCE_ISSUE,
    l.DISBURSEMENT_DATE,
    l.STATUS
FROM LOANS l
JOIN APPLICANTS a ON l.APPLICANT_ID = a.APPLICANT_ID
WHERE l.INTEREST_RATE > 15  -- Regulatory limit example
   OR l.LOAN_AMOUNT > 10000000  -- Regulatory limit example
   OR l.TERM_MONTHS > 60  -- Regulatory limit example
ORDER BY l.DISBURSEMENT_DATE DESC;

-- 10. AUDIT REPORT SUMMARY

SELECT 
    TO_CHAR(ACTION_DATE, 'YYYY-MM-DD') AS AUDIT_DATE,
    ACTION,
    COUNT(*) AS EVENT_COUNT,
    COUNT(DISTINCT LOAN_ID) AS UNIQUE_LOANS_AFFECTED,
    COUNT(DISTINCT USER_NAME) AS UNIQUE_USERS,
    MIN(ACTION_DATE) AS FIRST_EVENT_TIME,
    MAX(ACTION_DATE) AS LAST_EVENT_TIME
FROM LOAN_AUDIT
WHERE ACTION_DATE >= TRUNC(SYSDATE) - 30  -- Last 30 days
GROUP BY TO_CHAR(ACTION_DATE, 'YYYY-MM-DD'), ACTION
ORDER BY AUDIT_DATE DESC, EVENT_COUNT DESC;

-- 11. DATA QUALITY AUDIT

-- Incomplete loan records
SELECT 
    'MISSING_DISBURSEMENT_DATE' AS ISSUE_TYPE,
    COUNT(*) AS RECORD_COUNT
FROM LOANS
WHERE DISBURSEMENT_DATE IS NULL
UNION ALL
SELECT 
    'MISSING_STATUS' AS ISSUE_TYPE,
    COUNT(*) AS RECORD_COUNT
FROM LOANS
WHERE STATUS IS NULL
UNION ALL
SELECT 
    'INVALID_INTEREST_RATE' AS ISSUE_TYPE,
    COUNT(*) AS RECORD_COUNT
FROM LOANS
WHERE INTEREST_RATE <= 0 OR INTEREST_RATE > 50
UNION ALL
SELECT 
    'NEGATIVE_LOAN_AMOUNT' AS ISSUE_TYPE,
    COUNT(*) AS RECORD_COUNT
FROM LOANS
WHERE LOAN_AMOUNT <= 0;

-- 12. AUDIT TRAIL COMPLETENESS CHECK

-- Loans without any audit trail
SELECT 
    l.LOAN_ID,
    l.APPLICANT_ID,
    l.LOAN_AMOUNT,
    l.DISBURSEMENT_DATE,
    l.STATUS,
    (SELECT COUNT(*) FROM LOAN_AUDIT la WHERE la.LOAN_ID = l.LOAN_ID) AS AUDIT_RECORD_COUNT
FROM LOANS l
WHERE NOT EXISTS (
    SELECT 1 FROM LOAN_AUDIT la 
    WHERE la.LOAN_ID = l.LOAN_ID
)
ORDER BY l.DISBURSEMENT_DATE DESC;